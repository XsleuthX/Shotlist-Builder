<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Shot List Builder</title>
<style>

/* =============================
   Impression — Gold Glass Theme
   (CSS-only; HTML/JS untouched)
   ============================= */
:root{
  --gutter: clamp(18px, 4vw, 48px);
  --bg-0:#0a0e14; --bg-1:#0d121a; --bg-2:#111726;
  --ink:#eef2f7; --ink-dim:#b8c2d6;
  --line:#2a354a; --line-soft:rgba(255,255,255,.06);
  --accent:#e9d6a6;             /* warm gold */
  --accent-strong:#ffd87a;      /* bright gold highlight */
  --ok:#c2c522; --danger:#446cef;
  --shadow-1: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
  --r-xl:18px; --r-lg:14px; --r-md:10px; --r-sm:8px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
    radial-gradient(1200px 600px at 20% -10%, #1b2436 0%, transparent 60%),
    radial-gradient(1000px 500px at 120% 20%, #132034 0%, transparent 60%),
    linear-gradient(180deg, #080b10, #0a0e14 40%, #0a0e14);
}
/* Scrollbar */
*::-webkit-scrollbar{height:12px;width:12px}
*::-webkit-scrollbar-thumb{background:#1d2636;border:3px solid transparent;border-radius:12px;background-clip:padding-box}
*{scrollbar-color:#1d2636 transparent; scrollbar-width:thin}

/* Header */
header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(140%) blur(8px);
  background:linear-gradient(180deg, rgba(11,15,21,.85), rgba(11,15,21,.65) 70%, rgba(11,15,21,0));
  border-bottom:1px solid var(--line)}
.wrap{max-width:1200px; margin:0 auto; padding:12px var(--gutter)}
h1{margin:0 0 6px; font-size:18px; letter-spacing:.2px}
.sub{color:var(--ink-dim); margin-bottom:10px}


/* Bridge variables for Templates modal */
:root{ --panel: var(--bg-2); --text: var(--ink); --muted: var(--ink-dim); --accent: var(--accent); }
/* Toolbar */
.bar{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
.group{
  display:flex; gap:10px; padding:8px;
  background:rgba(255,255,255,.02);
  border:1px solid var(--line);
  border-radius:var(--r-xl);
  box-shadow:var(--shadow-1);
  backdrop-filter: blur(6px) saturate(120%);
}
.group .label{font-size:12px; color:var(--ink-dim); align-self:center; margin-right:2px; letter-spacing:.2px}

/* Buttons: transparent glass + gold dot */
button,.btn{
  position:relative;
  background:rgba(255,255,255,.04);
  color:var(--ink);
  border:1px solid var(--line);
  padding:10px 14px 10px 32px; border-radius:999px; cursor:pointer;
  box-shadow:var(--shadow-1);
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, transform .05s ease;
}
button:hover,.btn:hover{border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.055)}
button:active,.btn:active{transform:translateY(1px)}
button[disabled],.btn[disabled]{opacity:.55; cursor:not-allowed}
/* left gold dot */
button::before,.btn::before{
  content:"";
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  width:8px; height:8px; border-radius:50%;
  background: radial-gradient(circle at 35% 35%, #fff6d6 0, var(--accent) 50%, #826a2e 100%);
  box-shadow:0 0 0 2px rgba(233,214,166,.18), 0 0 12px rgba(233,214,166,.35);
}
/* Variants */
.btn.ok{border-color:#555b1e; background:(180deg, rgba(255,222,132,.8), rgba(255,222,132,.5));
                   color:rgba(255,222,132,.8); box-shadow:0 6px 18px rgba(255,222,132,.24), font}
.btn.ok::before{
  background:linear-gradient(180deg, rgba(255,222,132,.8), rgba(255,222,132,.5));
                   color:#0b1018; box-shadow:0 6px 18px rgba(255,222,132,.24), inset 0 1px 0 rgba(255,255,255,.25);
                   border-color:rgba(255,222,132,.35)}

.btn.danger{border-color:#8cdbff; background:rgba(#1b637f,.14); color:#d9feff}
.btn.danger::before{background: radial-gradient(circle at 35% 35%, #d9feff 0, #8cdbff 55%, #1b637f 100%); box-shadow:0 0 0 2px rgba(140, 251, 255, 0.18), 0 0 12px rgba(255,140,140,.32)}
.btn.muted{background:rgba(255,255,255,.03)}

/* file input label */
input[type=file]{display:none}
label.filebtn{display:inline-flex; align-items:center; gap:8px}

/* Segmented control */
.seg{display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden; background:rgba(255,255,255,.03)}
.seg button{border:0; background:transparent; padding:8px 12px; border-right:1px solid var(--line); border-radius:0}
.seg button:last-child{border-right:0}
.seg button.active{background:linear-gradient(180deg, rgba(255,222,132,.8), rgba(255,222,132,.5));
                   color:#0b1018; box-shadow:0 6px 18px rgba(255,222,132,.24), inset 0 1px 0 rgba(255,255,255,.25);
                   border-color:rgba(255,222,132,.35)}
/* Remove dots in segmented buttons */
.seg button::before{display:none}
.webp-controls button::before{display:none}

/* Dropzone */
.dropzone{border:1px dashed var(--line); border-radius:var(--r-xl); padding:24px; text-align:center;
  color:var(--ink-dim); background:rgba(255,255,255,.03); box-shadow:var(--shadow-1); backdrop-filter: blur(4px) saturate(110%)}
.dropzone.hover{border-color:var(--accent-strong); color:var(--ink)}

/* List Mode */
table{width:100%; border-collapse:separate; border-spacing:0 12px}
thead th{text-align:left; font-weight:600; color:var(--ink-dim); padding:0 8px 6px; font-size:12px; letter-spacing:.2px}
tbody tr{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:var(--r-xl); box-shadow:var(--shadow-1); backdrop-filter: blur(6px)}
tbody tr.dragging{opacity:.65; outline:1px dashed var(--accent-strong)}
td{padding:10px; vertical-align:top}
td.idx{width:56px; text-align:right; color:var(--ink-dim)}
td.drag{width:34px; cursor:grab}
.handle{width:10px; height:24px; background:repeating-linear-gradient(90deg,#9097a6 0 2px,transparent 2px 5px); opacity:.35; border-radius:3px; margin-top:3px}
img.thumb{width:160px; height:90px; object-fit:cover; border-radius:12px; display:block; background:#000; box-shadow:0 6px 16px rgba(0,0,0,.35)}
textarea,input[type=text],input[type=number],select{
  width:100%; background:rgba(255,255,255,.03);
  color:var(--ink); border:1px solid var(--line); border-radius:12px; padding:10px;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
}
textarea{min-height:68px; resize:vertical}
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.mini{font-size:12px; color:var(--ink-dim)}
.tags{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.chip{border:1px solid var(--line); background:rgba(255,255,255,.03); padding:4px 10px; border-radius:999px; font-size:12px; color:#cbd6ea}
.sel{width:36px; text-align:center}
.sel input{transform:scale(1.1); accent-color: var(--accent-strong)}

.topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.spacer{flex:1}

/* Batch panel */
.panel{background:rgba(255,255,255,.035); border:1px solid var(--line); border-radius:var(--r-xl); padding:0; overflow:hidden; box-shadow:var(--shadow-1); backdrop-filter: blur(6px)}
.panel .panel-summary{display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer; user-select:none}
.panel .panel-summary .title{font-weight:700; letter-spacing:.2px}
details.panel>.panel-summary::marker{content:""}
details.panel>.panel-summary::after{content:"▾"; margin-left:8px; color:var(--ink-dim)}
details.panel[open]>.panel-summary::after{content:"▴"}
.panel .panel-content{padding:12px}

/* Page Mode */
#pageContainer{margin-top:12px}
.page-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:12px}
.card{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:var(--r-xl); padding:12px; box-shadow:var(--shadow-1); backdrop-filter: blur(6px)}
.card.dragging{opacity:.65; outline:1px dashed var(--accent-strong)}
.card .head{display:flex; align-items:center; gap:10px; margin-bottom:8px}
.star{cursor:pointer; font-size:18px; line-height:1; user-select:none; color:#c0a96f}
.star.on{color:#ffd166; text-shadow:0 0 12px rgba(255,209,102,.35)}
.idxbadge{font:600 12px/1 ui-sans-serif,system-ui; color:#e6e2d1; padding:6px 8px; border-radius:10px; background:rgba(255,255,255,.03); border:1px solid var(--line)}
.title-input{flex:1; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid var(--line); color:var(--ink)}
.media{position:relative; margin-bottom:10px}
.media img,.media video{width:100%; height:200px; object-fit:cover; border-radius:14px; display:block; background:#000; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.replace{position:absolute; top:10px; right:10px}
.grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
.bar-l2{display:flex; gap:8px; align-items:center; margin-top:6px}
.format-chip{font-size:11px}
.drag-handle{width:12px; height:24px; background:repeating-linear-gradient(90deg,#9097a6 0 2px,transparent 2px 5px); opacity:.35; border-radius:3px; cursor:grab}
.toggleFields{border-radius:12px; padding:6px 10px}
.fields-collapsed .fields{display:none}
.fields-collapsed .toggleFields::after{content:"▸"}
.toggleFields::after{content:"▾"}

/* Footer */
footer{position:fixed; bottom:0; left:0; right:0; background:linear-gradient(0deg, rgba(11,15,21,.96), rgba(11,15,21,.75), rgba(11,15,21,0)); border-top:1px solid var(--line)}
.footwrap{max-width:1200px; margin:0 auto; padding:12px var(--gutter); display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; background:rgba(255,255,255,.03); border:1px solid var(--line); padding:2px 8px; border-radius:8px; font-size:12px; color:#e6e2d1; box-shadow:var(--shadow-1)}
.hidden{display:none!important}

</style>
<style>
/* ===== Gutter Guard (conflict-proof) ===== */
:root{ --gutter: clamp(18px, 4vw, 48px); }
header > .wrap,
footer > .footwrap{
  max-width: 1320px;
  margin-left: auto; margin-right: auto;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
}
main{
  max-width: 1320px;
  margin: 14px auto;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
}
@media (min-width: 1600px){
  header > .wrap, footer > .footwrap, main{ max-width: 1400px; }
}
</style>

<style>
/* Bottom gutter + footer-safe space */
:root{ --gutter: clamp(18px, 4vw, 48px); }
main{
  padding-bottom: max(var(--gutter), 120px) !important; /* leave room for fixed footer and match side gutters */
}
</style>


<style>
/* === Invisible Scrollbars (keep scroll behavior) === */
html, body{
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  -ms-overflow-style: none;           /* IE 10+ & old Edge */
  scrollbar-width: none;              /* Firefox */
  -webkit-overflow-scrolling: touch;  /* iOS momentum */
}
html::-webkit-scrollbar,
body::-webkit-scrollbar{
  width: 0 !important;
  height: 0 !important;
}

/* Optional: hide scrollbars on all inner scroll containers, while preserving scroll */
*{
  -ms-overflow-style: none;
  scrollbar-width: none;
}
*::-webkit-scrollbar{
  width: 0 !important;
  height: 0 !important;
}

/* === Replace button only on hover of media === */
.media .replace{
  opacity: 0;
  pointer-events: none;
  transform: translateY(-4px);
  transition: opacity .18s ease, transform .18s ease, filter .18s ease;
  filter: blur(.2px);
}
.media:hover .replace,
.media:focus-within .replace,
.replace:focus-visible{
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
  filter: none;
}
@media (hover: none) and (pointer: coarse){
  .media .replace{ opacity:1; pointer-events:auto; transform:none; filter:none; }
}
</style>


<style>
.webp-controls{display:flex;gap:.5rem;align-items:center;margin-top:.5rem;flex-wrap:wrap}
.webp-controls button{padding:6px 10px;border-radius:6px;border:1px solid var(--border,#333);background:var(--btn-bg,#222);color:inherit}
.webp-controls input[type=range]{width:240px}
canvas.webpCanvas{max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);}
</style>


<script>
// Ensure WebPPlayer exists early (runs before main script)
(function(){
  function dataURLtoBlob(dataURL){
    try{
      const [meta,b64] = dataURL.split(',');
      const mime = (meta.match(/^data:([^;]+);base64$/)||[])[1] || 'application/octet-stream';
      const bin=atob(b64); const len=bin.length; const u8=new Uint8Array(len); for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i);
      return new Blob([u8],{type:mime});
    }catch(e){ console.warn('dataURLtoBlob failed', e); return null; }
  }
  if ('WebPPlayer' in window) return;
  window._webpPlayers = window._webpPlayers || new Map();
  // Minimal WebP canvas player using WebCodecs
  class WebPPlayer {
    constructor(canvas, url){
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.url = url;
      this.frames = [];
      this.durations = [];
      this.size = null;
      this.index = 0;
      this.playing = false;
      this.t = null;
    }
    async load(){
      if (!('ImageDecoder' in window)) throw new Error('WebCodecs ImageDecoder not supported');
      const res = await fetch(this.url);
      const blob = await res.blob();
      const data = new Uint8Array(await blob.arrayBuffer());
      const decoder = new ImageDecoder({data, type:'image/webp'});
      await decoder.tracks.ready;
      const frameCount = decoder.tracks.selectedTrack?.frameCount ?? decoder.completeFrameCount ?? decoder.frameCount ?? 0;
      const count = Math.max(frameCount || 0, 1);
      this.frames = new Array(count);
      this.durations = new Array(count);
      for (let i=0; i<count; i++){
        const {image} = await decoder.decode({frameIndex:i});
        const bmp = await createImageBitmap(image);
        this.frames[i] = bmp;
        this.durations[i] = (typeof image.duration === 'number' && image.duration>0) ? image.duration : 100;
        this.size = {w: image.displayWidth || bmp.width, h: image.displayHeight || bmp.height};
        image.close();
      }
      decoder.close();
      this.canvas.width = this.size.w;
      this.canvas.height = this.size.h;
      this.draw(0);
    }
    draw(i){
      this.index = i|0;
      if(!this.frames.length) return;
      this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
      const frame = this.frames[this.index % this.frames.length];
      if(frame) this.ctx.drawImage(frame, 0, 0);
    }
    play(onIndex){
      if(this.playing || !this.frames.length) return;
      this.playing = true;
      const tick = () => {
        if(!this.playing) return;
        this.draw(this.index);
        try{ onIndex && onIndex(this.index); }catch{}
        const delay = this.durations[this.index] || 100;
        this.index = (this.index + 1) % this.frames.length;
        this.t = setTimeout(tick, delay);
      };
      tick();
    }
    pause(){
      this.playing = false;
      if(this.t){ clearTimeout(this.t); this.t = null; }
    }
    goto(i, onIndex){
      this.pause();
      this.draw(Math.max(0, Math.min(this.frames.length-1, i|0)));
      try{ onIndex && onIndex(this.index); }catch{}
    }
    seek(i, onIndex){
      this.index = Math.max(0, Math.min(this.frames.length-1, i|0));
      this.draw(this.index);
      try{ onIndex && onIndex(this.index); }catch{}
    }
rebindCanvas(newCanvas){
      if (!newCanvas || this.canvas === newCanvas) return;
      this.canvas = newCanvas;
      this.ctx = newCanvas.getContext('2d');
      if (this.size){
        this.canvas.width  = this.size.w;
        this.canvas.height = this.size.h;
      }
      this.draw(this.index|0);
    }

    dispose(){
      this.pause();
      for(const bmp of this.frames){ try{ bmp.close?.(); }catch{} }
      this.frames = [];
    }
  }
  window.WebPPlayer = WebPPlayer;
})();
</script>

<style id="drop-follow-box-style">
  #drop-follow-box{
    position:absolute;
    border:2px dashed #3b82f6;
    border-radius:12px;
    pointer-events:none;
    z-index:9999;
    background:rgba(59,130,246,0.06);
    display:none;
  }
</style>
</head>
<body>

<script id="drop-follow-box-script">
  (function(){
    if (window.ensureDropBox) return;
    window.ensureDropBox = function ensureDropBox(){
      var box = document.getElementById('drop-follow-box');
      if(!box){
        box = document.createElement('div');
        box.id = 'drop-follow-box';
        document.body.appendChild(box);
      }
      return box;
    };
  })();
</script>

<header>
  <div class="wrap">
    <h1>Shot List Builder</h1>
    <div class="sub">Batch drop your shots → reorder → annotate → export as JSON/CSV → print to PDF.</div>

    <div class="bar">
      <div class="group">
        <label class="filebtn btn"><input id="file" type="file" accept="image/*,video/*" multiple> Add Shots</label>
        <button id="clearAll" class="btn danger">Clear All</button>
      </div>

      <div class="group">
        <span class="label">Mode</span>
        <div class="seg">
          <button id="modeList" class="active">List</button>
          <button id="modePage">Page</button>
        </div>
        <label class="mini" style="display:inline-flex; gap:6px; align-items:center; margin-left:8px">
          <input type="checkbox" id="starFilter"> ★ Show starred only
        </label>
        <button id="collapseAllCards" class="btn" disabled title="Collapse all cards in Page Mode">Collapse All</button>
        <button id="expandAllCards" class="btn" disabled title="Expand all cards in Page Mode">Expand All</button>
      </div>

      <div class="group">
        <button id="selectAll" class="btn">Select All</button>
        <button id="deselectAll" class="btn muted">Deselect</button>
        <button id="deleteSel" class="btn danger">Delete Selected</button>
      </div>

      <div class="spacer"></div>

      <div class="group">
        <button id="printBtn" class="btn ok"> Print / Save to PDF</button>
        <button id="exportJSON" class="btn"> Export JSON</button>
        <label class="filebtn btn"><input id="importJSON" type="file" accept="application/json"> Import JSON</label>
        <button id="exportCSV" class="btn"> Export CSV</button>
        <button id="btnTemplates" class="btn"> Templates</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div id="dz" class="dropzone">
    <div><strong>Drop your screenshots here</strong> or use <span class="kbd">Add Shots</span>.</div>
    <div class="mini" style="margin-top:6px">Tips: you can drag rows/cards to reorder. Use the print button to generate a print-friendly view and “Save as PDF”.</div>
  </div>

  <!-- Collapsible Batch Tools -->
  <details id="batchPanel" class="panel" open style="margin-top:12px">
    <summary class="panel-summary"><span class="title">Batch Tools</span><span class="spacer"></span><span class="mini">click to show/hide</span></summary>
    <div class="panel-content">
      <div class="topbar">
        <div class="mini">Batch Edit Selected:</div>
        <input type="text" id="batchTitle" placeholder="Shot Title">
        <input type="text" id="batchTake" placeholder="Take">
        <input type="text" id="batchCamera" placeholder="Camera">
        <input type="text" id="batchLens" placeholder="Lens">
        <input type="text" id="batchNotes" placeholder="Notes">
        <input type="text" id="batchDesc" placeholder="Description">
        <button id="applyBatch" class="btn">Apply</button>
        <div class="spacer"></div>
        <div class="mini">Timecode:</div>
        <select id="tcMode" title="Timecode Mode">
          <option value="fromName">Use filename TC</option>
          <option value="timeline">Build timeline from 00:00:00:00</option>
        </select>
        <label class="mini">FPS <input id="fps" type="number" value="24" min="1" max="120" style="width:70px"></label>
        <label class="mini">Default dur (s) <input id="defaultDur" type="number" value="2" min="1" max="3600" style="width:80px"></label>
        <button id="parseTC" class="btn">Parse ↻</button>
      </div>
    </div>
  </details>

  <!-- List Mode -->
  <section id="listSection">
    <table style="margin-top:12px">
      <thead>
        <tr>
          <th class="sel"></th><th class="drag"></th><th class="idx">#</th>
          <th>Thumbnail</th><th>Core</th><th>Details</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <!-- Page Mode -->
  <section id="pageSection" class="hidden">
    <div id="pageContainer" class="page-grid"></div>
  </section>
</main>

<footer>
  <div class="footwrap mini">
    <div><strong>Shortcuts:</strong></div>
    <div class="kbd">⌘/Ctrl + A</div><div>select all</div>
    <div class="kbd">Delete</div><div>remove selected</div>
    <div class="kbd">P</div><div>print view</div>
  </div>
</footer>

<template id="row">
  <tr draggable="true">
    <td class="sel"><input type="checkbox" class="selbox"></td>
    <td class="drag"><div class="handle" title="Drag to reorder"></div></td>
    <td class="idx"></td>
    <td>
      <img class="thumb" alt="thumb">
      <div class="mini" data-filename></div>
      <div class="mini"><span class="starlist">☆</span> <span class="kind">IMG</span></div>
    </td>
    <td>
      <div class="grid2">
        <div>
          <label class="mini">Shot Title</label>
          <input type="text" class="title">
        </div>
        <div class="grid2">
          <div>
            <label class="mini">Start TC</label>
            <input type="text" class="starttc" placeholder="HH:MM:SS:FF">
          </div>
          <div>
            <label class="mini">End TC</label>
            <input type="text" class="endtc" placeholder="HH:MM:SS:FF">
          </div>
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="mini">Description</label>
        <textarea class="desc" placeholder="Action, purpose, notes..."></textarea>
      </div>
    </td>
    <td>
      <div class="grid2">
        <div>
          <label class="mini">Camera</label>
          <input type="text" class="camera" placeholder="FX3 / iPhone 15 / ...">
        </div>
        <div>
          <label class="mini">Lens</label>
          <input type="text" class="lens" placeholder="24-70mm @ 50mm">
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div>
          <label class="mini">Take</label>
          <input type="text" class="take" placeholder="A / B / 2nd">
        </div>
        <div>
          <label class="mini">Notes</label>
          <input type="text" class="notes" placeholder="Any extra notes">
        </div>
      </div>
      <div class="tags" style="margin-top:8px">
        <button class="btn danger mini del">Delete</button>
      </div>
    </td>
  </tr>
</template>

<template id="cardTpl">
  <div class="card fields-collapsed" draggable="true">
    <div class="head">
      <span class="star">☆</span>
      <span class="idxbadge">#001</span>
      <input class="title-input" type="text" placeholder="Shot Title">
      <button class="btn toggleFields" title="Show/Hide fields"></button>
      <div class="drag-handle" title="Drag to reorder"></div>
    </div>
    <div class="media">
      <img class="media-img" alt="thumb">
      <video class="media-vid hidden" controls playsinline></video>
      <button class="btn replace">Replace…</button>
      <input class="replaceInput" type="file" accept="image/*,video/*" style="display:none">
    </div>
    <div class="fields">
      <div class="grid3">
        <div>
          <label class="mini">Start TC</label>
          <input type="text" class="starttc" placeholder="HH:MM:SS:FF">
        </div>
        <div>
          <label class="mini">End TC</label>
          <input type="text" class="endtc" placeholder="HH:MM:SS:FF">
        </div>
        <div>
          <label class="mini">Take</label>
          <input type="text" class="take" placeholder="A / B / 2nd">
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div>
          <label class="mini">Camera</label>
          <input type="text" class="camera" placeholder="FX3 / iPhone 15 / ...">
        </div>
        <div>
          <label class="mini">Lens</label>
          <input type="text" class="lens" placeholder="24-70mm @ 50mm">
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="mini">Description</label>
        <textarea class="desc" placeholder="Action, purpose, notes..."></textarea>
      </div>
      <div class="bar-l2">
        <span class="chip format-chip kind">IMG</span>
        <span class="mini filename"></span>
        <div class="spacer"></div>
        <button class="btn danger mini del">Delete</button>
      </div>
    </div>
  </div>
</template>

<script>
  const fileInput = document.getElementById('file');
  const dz = document.getElementById('dz');
  const tbody = document.getElementById('tbody');
  const rowTpl = document.getElementById('row');
  const cardTpl = document.getElementById('cardTpl');
  const listSection = document.getElementById('listSection');
  const pageSection = document.getElementById('pageSection');
  const pageContainer = document.getElementById('pageContainer');
  const selectAllBtn = document.getElementById('selectAll');
  const deselectAllBtn = document.getElementById('deselectAll');
  const deleteSelBtn = document.getElementById('deleteSel');
  const clearAllBtn = document.getElementById('clearAll');
  const printBtn = document.getElementById('printBtn');
  const exportJSONBtn = document.getElementById('exportJSON');
  const importJSONInput = document.getElementById('importJSON');
  const exportCSVBtn = document.getElementById('exportCSV');
  const parseTCBtn = document.getElementById('parseTC');
  const applyBatchBtn = document.getElementById('applyBatch');
  const batchTitle = document.getElementById('batchTitle');
  const batchTake = document.getElementById('batchTake');
  const batchCamera = document.getElementById('batchCamera');
  const batchLens = document.getElementById('batchLens');
  const batchNotes = document.getElementById('batchNotes');
  const batchDesc = document.getElementById('batchDesc');
  const tcMode = document.getElementById('tcMode');
  const fpsInput = document.getElementById('fps');
  const defaultDurInput = document.getElementById('defaultDur');
  const modeListBtn = document.getElementById('modeList');
  const modePageBtn = document.getElementById('modePage');
  const starFilter = document.getElementById('starFilter');
  const collapseAllCardsBtn = document.getElementById('collapseAllCards');
  const expandAllCardsBtn = document.getElementById('expandAllCards');

  let shots = []; // includes {collapsed:boolean}
  let mode = 'list';
  let renderCount = 0;
  const BATCH_SIZE = Infinity;

  const readAsDataURL = (file)=> new Promise((res, rej)=>{
    const fr = new FileReader(); fr.onerror = rej; fr.onload = ()=> res(fr.result); fr.readAsDataURL(file);
  });

  async function downscale(dataUrl, maxW=1280, maxH=1280, q=.85){
    const img = new Image(); img.decoding='async'; img.src = dataUrl; await img.decode().catch(()=>{});
    const r = Math.min(1, maxW/img.width, maxH/img.height);
    const cw = Math.round(img.width*r), ch = Math.round(img.height*r);
    const c = document.createElement('canvas'); c.width=cw; c.height=ch;
    const ctx = c.getContext('2d'); ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,cw,ch);
    return c.toDataURL('image/jpeg', q);
  }

  function guessFormatFromFilename(name){
    const m = String(name).match(/\.([a-z0-9]+)$/i); if(!m) return 'IMG';
    const ext = m[1].toUpperCase(); return ext==='JPG' ? 'JPEG' : ext;
  }
  function inferFormat(file){
    if(file && file.type){ const [,ext]=file.type.split('/'); return ext?ext.toUpperCase():guessFormatFromFilename(file.name) }
    return guessFormatFromFilename(file?.name||'');
  }

  function inferTimecode(name){
    const base = name.replace(/\.[^.]+$/,'');
    const m = base.match(/(?:^|[_\- ])(\d{1,2})[._-](\d{2})[._-](\d{2})(?:[._-](\d{2}))?/);
    if(!m) return ''; const hh=m[1].padStart(2,'0'), mm=m[2], ss=m[3], ff=m[4]||'00';
    return `${hh}:${mm}:${ss}:${ff}`;
  }
  function tcToFrames(tc, fps){
    if(!tc) return null;
    const m = tc.match(/^(\d{1,2}):(\d{2}):(\d{2})(?::(\d{2}))?$/); if(!m) return null;
    const hh=+m[1], mm=+m[2], ss=+m[3], ff=+(m[4]||0);
    return Math.round(((hh*3600+mm*60+ss)*fps)+ff);
  }
  function framesToTC(frames, fps){
    frames = Math.max(0, Math.round(frames));
    const totalSec = Math.floor(frames / fps), ff = frames % fps;
    const hh = Math.floor(totalSec/3600), mm=Math.floor((totalSec%3600)/60), ss=totalSec%60;
    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}:${String(ff).padStart(2,'0')}`;
  }

// Detect if a WebP is animated by reading RIFF chunks (VP8X flag or ANIM chunk)
async function isAnimatedWebP(file){
  try{
    const buf = await file.arrayBuffer();
    const u8 = new Uint8Array(buf);
    const len = u8.length;
    const tagAt = (i)=> String.fromCharCode(u8[i],u8[i+1],u8[i+2],u8[i+3]||0);
    const u32LE = (i)=> (u8[i] | (u8[i+1]<<8) | (u8[i+2]<<16) | (u8[i+3]<<24)>>>0);
    if(len < 16) return false;
    if(tagAt(0) !== 'RIFF' || tagAt(8) !== 'WEBP') return false;
    let off = 12;
    while(off + 8 <= len){
      const tag = tagAt(off);
      const size = u32LE(off+4) >>> 0;
      const dataOff = off + 8;
      if(tag === 'VP8X' && dataOff + 1 < len){
        const flags = u8[dataOff];
        if((flags & 0x02) !== 0) return true; // animation flag
      }
      if(tag === 'ANIM') return true;
      off = dataOff + size + (size & 1); // chunks padded to even size
    }
    return false;
  }catch{
    return false;
  }
}


  async function videoPoster(file, time=0.1){
    return new Promise((resolve)=>{
      const url = URL.createObjectURL(file), v = document.createElement('video');
      v.preload='metadata'; v.muted=true; v.playsInline=true; v.src=url;
      v.addEventListener('loadedmetadata', ()=>{
        const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; const ctx=c.getContext('2d');
        const grab = ()=>{ try{ ctx.drawImage(v,0,0,c.width,c.height); resolve(c.toDataURL('image/jpeg',.85)); }catch{ resolve(''); } URL.revokeObjectURL(url); };
        if(isFinite(v.duration)&&v.duration>0){ v.currentTime=Math.min(time,Math.max(0,v.duration-0.2)); v.addEventListener('seeked',grab,{once:true}); }
        else { v.addEventListener('loadeddata',grab,{once:true}); }
      }, {once:true});
      v.addEventListener('error', ()=>{ URL.revokeObjectURL(url); resolve(''); }, {once:true});
    });
  }

  function setPageModeButtonsState(){ const on = mode==='page'; collapseAllCardsBtn.disabled=!on; expandAllCardsBtn.disabled=!on; }
  modeListBtn.addEventListener('click', ()=>{ mode='list'; modeListBtn.classList.add('active'); modePageBtn.classList.remove('active'); listSection.classList.remove('hidden'); pageSection.classList.add('hidden'); setPageModeButtonsState(); render(); });
  modePageBtn.addEventListener('click', ()=>{ mode='page'; modePageBtn.classList.add('active'); modeListBtn.classList.remove('active'); listSection.classList.add('hidden'); pageSection.classList.remove('hidden'); setPageModeButtonsState(); resetInfinite(); render(); });
  starFilter.addEventListener('change', ()=>{ resetInfinite(); render(); });
  setPageModeButtonsState();

  collapseAllCardsBtn.addEventListener('click', ()=>{ shots.forEach(s=>s.collapsed=true); render(); });
  expandAllCardsBtn.addEventListener('click', ()=>{ shots.forEach(s=>s.collapsed=false); render(); });

  function filteredShots(){ return starFilter.checked ? shots.filter(s=>s.starred) : shots; }

  function render(){ mode==='list' ? renderList() : renderPage(); }

  function renderList(){
    tbody.innerHTML='';
    filteredShots().forEach((s,i)=>{
      const tr = rowTpl.content.firstElementChild.cloneNode(true); tr.dataset.id=s.id;
      tr.querySelector('.idx').textContent=String(i+1).padStart(3,'0');
      const thumbImg = tr.querySelector('img.thumb');
      thumbImg.src = s.thumb || '';
      if (s.imageURL){
        thumbImg.addEventListener('mouseenter', ()=>{ thumbImg.src = s.imageURL; });
        thumbImg.addEventListener('mouseleave', ()=>{ thumbImg.src = s.thumb || ''; });
        thumbImg.title = 'Hover to preview';
      }
      tr.querySelector('[data-filename]').textContent=s.filename;
      tr.querySelector('.selbox').checked=!!s.selected;
      tr.querySelector('.title').value=s.title||''; tr.querySelector('.starttc').value=s.startTC||''; tr.querySelector('.endtc').value=s.endTC||'';
      tr.querySelector('.desc').value=s.desc||''; tr.querySelector('.camera').value=s.camera||''; tr.querySelector('.lens').value=s.lens||'';
      tr.querySelector('.take').value=s.take||''; tr.querySelector('.notes').value=s.notes||'';
      tr.querySelector('.kind').textContent=s.format||guessFormatFromFilename(s.filename);
      const starEl=tr.querySelector('.starlist'); starEl.textContent=s.starred?'★':'☆'; starEl.style.cursor='pointer';
      starEl.addEventListener('click',()=>{ s.starred=!s.starred; render(); });

      tr.setAttribute('draggable','false');
const handle = tr.querySelector('td.drag .handle');
if (handle) handle.setAttribute('draggable','true');
if (handle) handle.addEventListener('dragstart',(e)=>{
  e.stopPropagation();
  tr.classList.add('dragging');
  e.dataTransfer.setData('text/plain', s.id);
  e.dataTransfer.effectAllowed = 'move';
  const box = window.ensureDropBox ? window.ensureDropBox() : null;
  if (box) box.style.display = 'block';
});
if (handle) handle.addEventListener('dragend',(e)=>{
  e.stopPropagation();
  tr.classList.remove('dragging');
  const box = window.ensureDropBox ? window.ensureDropBox() : null;
  if (box) box.style.display = 'none';
});
tr.addEventListener('dragover',(e)=>{
  e.preventDefault();
  tr.classList.add('ghost');
  const box = window.ensureDropBox ? window.ensureDropBox() : null;
  if (box){
    const r = tr.getBoundingClientRect();
    box.style.left = (window.scrollX + r.left) + 'px';
    box.style.top  = (window.scrollY + r.top) + 'px';
    box.style.width  = r.width + 'px';
    box.style.height = r.height + 'px';
    box.style.display = 'block';
  }
});
tr.addEventListener('dragleave',()=>{
  tr.classList.remove('ghost');
  const box = window.ensureDropBox ? window.ensureDropBox() : null;
  if (box) box.style.display = 'none';
});
tr.addEventListener('drop',(e)=>{
  e.preventDefault();
  tr.classList.remove('ghost');
  const box = window.ensureDropBox ? window.ensureDropBox() : null;
  if (box) box.style.display = 'none';
  reorderById(e.dataTransfer.getData('text/plain'), s.id);
});
tr.querySelector('.selbox').addEventListener('change',e=> s.selected=e.target.checked);
      tr.querySelector('.title').addEventListener('input',e=> s.title=e.target.value);
      tr.querySelector('.starttc').addEventListener('input',e=> s.startTC=e.target.value);
      tr.querySelector('.endtc').addEventListener('input',e=> s.endTC=e.target.value);
      tr.querySelector('.desc').addEventListener('input',e=> s.desc=e.target.value);
      tr.querySelector('.camera').addEventListener('input',e=> s.camera=e.target.value);
      tr.querySelector('.lens').addEventListener('input',e=> s.lens=e.target.value);
      tr.querySelector('.take').addEventListener('input',e=> s.take=e.target.value);
      tr.querySelector('.notes').addEventListener('input',e=> s.notes=e.target.value);

      tr.querySelector('.del').addEventListener('click',()=> removeShot(s.id));
      tbody.appendChild(tr);
    });
  }

  function resetInfinite(){ renderCount = Math.min(BATCH_SIZE, filteredShots().length); }
  window.addEventListener('scroll',()=>{
    if(mode!=='page') return;
    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800);
    if(nearBottom){ renderCount = Math.min(filteredShots().length, renderCount + BATCH_SIZE); renderPage(); }
  });

  function renderPage(){
    const list = filteredShots(); if(renderCount===0) resetInfinite();
    pageContainer.innerHTML='';
    list.slice(0,renderCount).forEach((s,i)=>{
      const card = cardTpl.content.firstElementChild.cloneNode(true); card.dataset.id=s.id;
      card.querySelector('.idxbadge').textContent=`#${String(i+1).padStart(3,'0')}`;
      const starEl=card.querySelector('.star'); starEl.classList.toggle('on',!!s.starred); starEl.textContent=s.starred?'★':'☆';
      starEl.addEventListener('click',()=>{ s.starred=!s.starred; render(); });

      const titleInput=card.querySelector('.title-input'); titleInput.value=s.title||''; titleInput.addEventListener('input',e=> s.title=e.target.value);

      const img=card.querySelector('.media-img'); const vid=card.querySelector('.media-vid');
      const replaceBtn=card.querySelector('.replace'); const replaceInput=card.querySelector('.replaceInput');
      if(s.mediaType==='video' && s.previewURL){ 
        vid.classList.remove('hidden'); img.classList.add('hidden'); 
        // hide canvas/controls if present
        const holder = img.parentElement;
        const canvas = holder.querySelector('canvas.webpCanvas'); if(canvas) canvas.classList.add('hidden');
        const ctrls = holder.querySelector('.webp-controls'); if(ctrls) ctrls.classList.add('hidden');
        vid.src=s.previewURL; vid.poster=s.thumb||''; 
      }
      else { 
        const holder = img.parentElement;
        let canvas = holder.querySelector('canvas.webpCanvas');
        let ctrls = holder.querySelector('.webp-controls');
        if(!canvas){ canvas = document.createElement('canvas'); canvas.className='webpCanvas hidden'; img.after(canvas); }
        if(!ctrls){
          ctrls = document.createElement('div'); ctrls.className='webp-controls hidden';
          ctrls.innerHTML = `
            <label style="display:flex;align-items:center;gap:.5rem;">
              <span>Frame</span>
              <input type="range" min="0" max="0" value="0" step="1" data-act="slider">
              <span data-act="label">0/0</span>
            </label>`;
          canvas.after(ctrls);
        }
          const slider = ctrls.querySelector('[data-act=slider]');
          const label  = ctrls.querySelector('[data-act=label]');
          const getPlayer = ()=> (window._webpPlayers && window._webpPlayers.get(s.id)) || null;
          const updateUIFromIndex = (idx)=>{
            const p = getPlayer();
            const total = p && p.frames ? p.frames.length : 0;
            label.textContent = total ? `${idx+1}/${total}` : `${idx+1}`;
            if (document.activeElement !== slider) slider.value = String(idx);
            s.webpFrame = idx;
          };
          // Wire slider to seek frames
          slider.oninput = () => {
            const p = getPlayer(); if (!p) return;
            const idx = parseInt(slider.value || '0', 10);
            p.seek(idx, updateUIFromIndex);
          };

        
        if (s.imageURL){
          // Use canvas + controls
          img.classList.add('hidden'); vid.classList.add('hidden');
          canvas.classList.remove('hidden'); ctrls.classList.remove('hidden');
          // Show placeholder while loading
          canvas.getContext('2d').fillStyle = '#111';
          canvas.width = img.naturalWidth||320; canvas.height = img.naturalHeight||180;
          canvas.getContext('2d').fillRect(0,0,canvas.width,canvas.height);
          canvas.getContext('2d').fillStyle='#999';
          canvas.getContext('2d').fillText('Loading WebP…', 10, 20);

          window._webpPlayers = window._webpPlayers || new Map();
          let player = window._webpPlayers.get(s.id);
          const ensureLoaded = async ()=>{
            if (typeof WebPPlayer === 'undefined'){
              const startTs = Date.now();
              const poll = ()=>{
                if (typeof WebPPlayer !== 'undefined'){ ensureLoaded(); return; }
                if (Date.now() - startTs > 5000){ console.warn('WebPPlayer not available'); return; }
                setTimeout(poll, 50);
              };
              poll(); return;
            }
            window._webpPlayers = window._webpPlayers || new Map();
            let player = window._webpPlayers.get(s.id);
            if (player && player.url !== s.imageURL){
              try{ player.dispose(); }catch{};
              window._webpPlayers.delete(s.id);
              player = null;
            }
            if(!player){
              player = new WebPPlayer(canvas, s.imageURL);
              window._webpPlayers.set(s.id, player);
              try{ await player.load(); }catch(e){ console.warn('WebP load failed', e); }
            }
            if (player.canvas !== canvas) player.rebindCanvas(canvas);
            const total = player.frames.length;
            s.webpTotalFrames = total || 0;
            slider.max = String(Math.max(0, total-1));
            const startIdx = Number.isInteger(s.webpFrame) ? (s.webpFrame|0) : (player.index|0);
            player.seek(startIdx, updateUIFromIndex);
    };
          ensureLoaded();
          
          // Store cleanup hook on holder for when navigating away
          holder._disposeWebP = ()=>{ try{ const p=(window._webpPlayers&&window._webpPlayers.get(s.id))||null; if(p && p.pause) p.pause(); }catch{}; /* keep cached frames */ };
        }else{
          // Fallback to static poster behavior
          if (holder._disposeWebP){ try{ holder._disposeWebP(); }catch{}; holder._disposeWebP=null; }
          canvas.classList.add('hidden'); ctrls.classList.add('hidden');
          img.classList.remove('hidden'); vid.classList.add('hidden');
          img.src = s.thumb || '';
        }
      }
      replaceBtn.addEventListener('click',()=> replaceInput.click());
      replaceInput.addEventListener('change',async (e)=>{ const f=e.target.files[0]; if(!f) return; await replaceMedia(s,f); render(); });

      const toggleBtn=card.querySelector('.toggleFields');
      if(s.collapsed) card.classList.add('fields-collapsed'); else card.classList.remove('fields-collapsed');
      toggleBtn.addEventListener('click',(e)=>{
        const multi = e.altKey||e.metaKey||e.ctrlKey;
        if(multi){ const ns=!s.collapsed; shots.forEach(x=> x.collapsed=ns); }
        else s.collapsed=!s.collapsed;
        render();
      });

      card.querySelector('.starttc').value=s.startTC||'';
      card.querySelector('.endtc').value=s.endTC||'';
      card.querySelector('.take').value=s.take||'';
      card.querySelector('.camera').value=s.camera||'';
      card.querySelector('.lens').value=s.lens||'';
      card.querySelector('.desc').value=s.desc||'';
      card.querySelector('.filename').textContent=s.filename;
      card.querySelector('.kind').textContent=s.format||guessFormatFromFilename(s.filename);

      ['starttc','endtc','take','camera','lens','desc'].forEach(cls=>{
        card.querySelector('.'+cls).addEventListener('input',e=> s[cls==='starttc'?'startTC':cls==='endtc'?'endTC':cls]=e.target.value);
      });

      const dragHandle = card.querySelector('.drag-handle');
card.setAttribute('draggable','false');
if (dragHandle) dragHandle.setAttribute('draggable','true');
if (dragHandle) dragHandle.addEventListener('dragstart',(e)=>{
  e.stopPropagation();
  card.classList.add('dragging');
  e.dataTransfer.setData('text/plain', s.id);
  e.dataTransfer.effectAllowed = 'move';
  const box = ensureDropBox();
  box.style.display = 'block';
});
if (dragHandle) dragHandle.addEventListener('dragend',(e)=>{
  e.stopPropagation();
  card.classList.remove('dragging');
  const box = ensureDropBox();
  box.style.display = 'none';
});
// Prevent dragging from anywhere except the handle
card.addEventListener('dragstart', (e)=>{ e.preventDefault(); });
// Make sure the WebP frame slider never bubbles into a drag
const webpSliderEl = card.querySelector('.webp-controls input[type=range]');
if (webpSliderEl){
  ['mousedown','pointerdown','touchstart','dragstart'].forEach(ev=>
    webpSliderEl.addEventListener(ev, evObj => evObj.stopPropagation())
  );
}
// Position the drop-follow box over the card under the cursor
card.addEventListener('dragover',(e)=>{
  e.preventDefault();
  const box = ensureDropBox();
  const r = card.getBoundingClientRect();
  box.style.left = (window.scrollX + r.left) + 'px';
  box.style.top  = (window.scrollY + r.top) + 'px';
  box.style.width  = r.width + 'px';
  box.style.height = r.height + 'px';
  box.style.display = 'block';
});
card.addEventListener('dragleave',()=>{
  const box = ensureDropBox();
  box.style.display = 'none';
});
card.addEventListener('drop',(e)=>{
  e.preventDefault();
  const box = ensureDropBox();
  box.style.display = 'none';
  reorderById(e.dataTransfer.getData('text/plain'), s.id);
});
card.addEventListener('dragover',(e)=>{ e.preventDefault(); card.classList.add('ghost'); });
      card.addEventListener('dragleave',()=> card.classList.remove('ghost'));
      card.addEventListener('drop',(e)=>{ e.preventDefault(); card.classList.remove('ghost'); reorderById(e.dataTransfer.getData('text/plain'), s.id); });

      card.querySelector('.del').addEventListener('click',()=> removeShot(s.id));
      pageContainer.appendChild(card);
    });
  }

  function reorderById(srcId,destId){
    if(!srcId||srcId===destId) return;
    const from=shots.findIndex(x=>x.id===srcId), to=shots.findIndex(x=>x.id===destId);
    if(from<0||to<0) return; const [moved]=shots.splice(from,1); shots.splice(to,0,moved); render();
  }
  function removeShot(id){
    const s=shots.find(x=>x.id===id);
    if(s){
      if(s.mediaType==='video'&&s.previewURL) try{ URL.revokeObjectURL(s.previewURL);}catch{}
      if(s.imageURL) try{ URL.revokeObjectURL(s.imageURL);}catch{}
    }
    shots=shots.filter(x=>x.id!==id); render();
  }

  // ingest
  fileInput.addEventListener('change', async (e)=>{ await addFiles(e.target.files); fileInput.value=''; });
  ['dragenter','dragover'].forEach(evt=> dz.addEventListener(evt,(e)=>{ e.preventDefault(); dz.classList.add('hover'); }));
  ['dragleave','drop'].forEach(evt=> dz.addEventListener(evt,(e)=>{ e.preventDefault(); dz.classList.remove('hover'); }));
  dz.addEventListener('drop', async (e)=>{ await addFiles(e.dataTransfer.files); });

  async function addFiles(list){
  for (const f of [...list]){
    if(!f.type || !(f.type.startsWith('image/')||f.type.startsWith('video/'))) continue;
    if(f.type.startsWith('image/')){
      if (f.type === 'image/webp'){
        const [dataUrl, anim] = await Promise.all([readAsDataURL(f), isAnimatedWebP(f)]);
        const thumb = await downscale(dataUrl,1600,1600,.85);
        const url = URL.createObjectURL(f);
        shots.push({
          id: crypto.randomUUID(),
          filename: f.name,
          format: inferFormat(f),
          mediaType: 'image',
          thumb,
          imageURL: url,
          isAnimated: !!anim,
          webpFrame: 0,
          webpTotalFrames: 0,
          title: '',
          startTC: '',
          endTC: '',
          desc: '',
          camera: '',
          lens: '',
          take: '',
          notes: '',
          selected: false,
          starred: false,
          collapsed: true
        });
      }else{
        const dataUrl = await readAsDataURL(f);
        const thumb  = await downscale(dataUrl,1600,1600,.85);
        shots.push({
          id: crypto.randomUUID(),
          filename: f.name,
          format: inferFormat(f),
          mediaType: 'image',
          thumb,
          isAnimated: false,
          webpFrame: 0,
          webpTotalFrames: 0,
          title: '',
          startTC: '',
          endTC: '',
          desc: '',
          camera: '',
          lens: '',
          take: '',
          notes: '',
          selected: false,
          starred: false,
          collapsed: true
        });
      }
    }else{
      const poster = await videoPoster(f) || '';
      const url = URL.createObjectURL(f);
      shots.push({
        id: crypto.randomUUID(),
        filename: f.name,
        format: inferFormat(f),
        mediaType: 'video',
        previewURL: url,
        thumb: poster,
        webpFrame: 0,
        webpTotalFrames: 0,
        title: '',
        startTC: '',
        endTC: '',
        desc: '',
        camera: '',
        lens: '',
        take: '',
        notes: '',
        selected: false,
        starred: false,
        collapsed: true
      });
    }
  }
  
}

  async function replaceMedia(shot,file){
  if(!file || !(file.type && (file.type.startsWith('image/')||file.type.startsWith('video/')))) return;
  if(shot.mediaType==='video' && shot.previewURL) try{ URL.revokeObjectURL(shot.previewURL);}catch{}
  if(shot.imageURL) { try{ URL.revokeObjectURL(shot.imageURL); }catch{} }
  shot.filename=file.name; shot.format=inferFormat(file);
  if(file.type.startsWith('image/')){
    if (file.type === 'image/webp'){
      const [dataUrl, anim] = await Promise.all([readAsDataURL(file), isAnimatedWebP(file)]);
      const thumb=await downscale(dataUrl,1600,1600,.85);
      shot.mediaType='image'; shot.thumb=thumb; delete shot.previewURL;
      shot.isAnimated=!!anim;
      shot.imageURL = URL.createObjectURL(file);
      shot.webpFrame = 0;
      shot.webpTotalFrames = 0;
    }else{
      const dataUrl=await readAsDataURL(file); const thumb=await downscale(dataUrl,1600,1600,.85);
      shot.mediaType='image'; shot.thumb=thumb; delete shot.previewURL; shot.isAnimated=false;
      shot.webpFrame = 0; shot.webpTotalFrames = 0;
      if(shot.imageURL){ try{ URL.revokeObjectURL(shot.imageURL);}catch{} } delete shot.imageURL;
    }
  }else{
    const poster=await videoPoster(file)||''; shot.mediaType='video'; shot.previewURL=URL.createObjectURL(file); shot.thumb=poster; shot.isAnimated=false; shot.webpFrame=0; shot.webpTotalFrames=0;
    if(shot.imageURL){ try{ URL.revokeObjectURL(shot.imageURL);}catch{} } delete shot.imageURL;
  }
}

  // selection
  selectAllBtn.addEventListener('click',()=>{ shots.forEach(s=>s.selected=true); render(); });
  deselectAllBtn.addEventListener('click',()=>{ shots.forEach(s=>s.selected=false); render(); });
  deleteSelBtn.addEventListener('click',()=>{ shots.filter(s=>s.selected).map(s=>s.id).forEach(removeShot); });
  clearAllBtn.addEventListener('click',()=>{ if(confirm('Remove all items?')){ shots.forEach(s=>{ if(s.mediaType==='video'&&s.previewURL) try{URL.revokeObjectURL(s.previewURL);}catch{}; if(s.imageURL) try{URL.revokeObjectURL(s.imageURL);}catch{} }); shots=[]; render(); }});

  // batch replace (not append)
  applyBatchBtn.addEventListener('click',()=>{
    const title=batchTitle.value.trim(), take=batchTake.value.trim(), cam=batchCamera.value.trim(), len=batchLens.value.trim(),
          note=batchNotes.value.trim(), desc=batchDesc.value.trim();
    shots.forEach(s=>{ if(!s.selected) return;
      if(title) s.title=title; if(take) s.take=take; if(cam) s.camera=cam; if(len) s.lens=len; if(note) s.notes=note; if(desc) s.desc=desc; });
    render();
  });

  // timecode parse
  parseTCBtn.addEventListener('click',()=>{
    const modeSel=tcMode.value, fps=parseInt(fpsInput.value)||24, defDur=Math.max(1,parseInt(defaultDurInput.value)||2);
    if(modeSel==='fromName'){
      shots.forEach(s=>{ const tc=inferTimecode(s.filename); if(tc){ s.startTC=tc; s.endTC=''; } });
    }else{
      const nameFrames=shots.map(s=> tcToFrames(inferTimecode(s.filename), fps));
      const durations=shots.map((_,i)=>{ const a=nameFrames[i], b=nameFrames[i+1]; return (a!=null && b!=null && b>a) ? (b-a) : defDur*fps; });
      if(durations.length && !durations[durations.length-1]) durations[durations.length-1]=defDur*fps;
      let acc=0; shots.forEach((s,i)=>{ const d=durations[i]||defDur*fps; s.startTC=framesToTC(acc,fps); s.endTC=framesToTC(acc+d,fps); acc+=d; });
    }
    render();
  });

  // export/import
  
exportJSONBtn.addEventListener('click', async ()=>{
  const blobToDataURL = (blob)=> new Promise((res,rej)=>{
    try{ const fr = new FileReader(); fr.onerror = rej; fr.onload = ()=> res(fr.result); fr.readAsDataURL(blob); }
    catch(e){ rej(e); }
  });
  const outShots = [];
  for (const s of shots){
    const { previewURL, imageURL, ...rest } = s;
    const out = { ...rest };
    // Embed animated WebP bytes so import can restore playback
    if (s.mediaType === 'image' && (s.isAnimated || (String(s.format).toUpperCase()==='WEBP' && ((s.webpTotalFrames|0)>1 || (s.webpFrame|0)>0))) && imageURL){
      try{
        const resp = await fetch(imageURL);
        const blob = await resp.blob();
        out.imageData = await blobToDataURL(blob);
      }catch(e){ console.warn('Failed to embed WebP data for export', e); }
    }
    outShots.push(out);
  }
  const data = { meta:{app:'shotlist-maker', v:6, exported:new Date().toISOString()}, shots: outShots };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='shotlist.json'; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 0);
});
  
importJSONInput.addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const dataURLtoBlob = (dataURL)=>{
    try{
      const [meta, b64] = dataURL.split(',');
      const mime = (meta.match(/^data:([^;]+);base64$/)||[])[1] || 'application/octet-stream';
      const bin = atob(b64); const len = bin.length;
      const u8 = new Uint8Array(len); for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], {type: mime});
    }catch(e){ console.warn('dataURLtoBlob failed', e); return null; }
  };
  try{
    const data=JSON.parse(await f.text());
    if(Array.isArray(data.shots)){
      shots = data.shots.map((s)=>{
        const base = {
          selected:false, starred:!!s.starred, collapsed:true,
          startTC: s.startTC || s.timecode || '',
          format: s.format || (typeof guessFormatFromFilename==='function' && s.filename ? guessFormatFromFilename(s.filename) : s.format),
          mediaType: s.mediaType || 'image',
          ...s
        };
        // Restore animated WebP from embedded data
        if (base.mediaType === 'image' && base.imageData){
          const blob = dataURLtoBlob(base.imageData);
          if (blob){
            try{ base.imageURL = URL.createObjectURL(blob); base.isAnimated = true; if(!base.format) base.format='WEBP'; }catch{}
          }
        }
        base.isAnimated = !!base.isAnimated;
        base.webpFrame = Number.isInteger(base.webpFrame) ? base.webpFrame : 0;
        base.webpTotalFrames = Number.isInteger(base.webpTotalFrames) ? base.webpTotalFrames : 0;
        return base;
      });
      if (typeof resetInfinite === 'function') resetInfinite();
      if (typeof render === 'function') render();
    } else {
      alert('JSON missing "shots" array.');
    }
  }catch(err){
    console.error(err);
    alert('Failed to import JSON.');
  }
  importJSONInput.value='';
});

<!-- Templates adapter for Shot List Maker -->
(function(){
  function applyShotTemplate(tpl){
    try{
      const defaults = tpl && (tpl.defaults || tpl.default) || {};
      const selected = (Array.isArray(window.shots) ? window.shots.filter(s=>s.selected) : []);
      const target = selected.length ? selected : (window.shots || []);
      if (defaults && typeof defaults === 'object'){
        target.forEach(s=>{
          if(defaults.titlePrefix && !s.title) s.title = defaults.titlePrefix;
          if(defaults.camera != null) s.camera = defaults.camera;
          if(defaults.lens   != null) s.lens   = defaults.lens;
          if(defaults.take   != null) s.take   = defaults.take;
          if(defaults.notes  != null) s.notes  = defaults.notes;
          if(defaults.starred!= null) s.starred= !!defaults.starred;
        });
      }
      if (Array.isArray(tpl && tpl.shots) && tpl.shots.length){
        const mode = tpl.mode || 'apply';
        if (mode === 'replace'){
          window.shots = tpl.shots.map((r,i)=> {
            const base = { 
            id: crypto.randomUUID(),
            filename: r.filename || '',
            format: r.format || (typeof guessFormatFromFilename==='function' && r.filename ? guessFormatFromFilename(r.filename) : ''),
            mediaType: r.mediaType || 'image',
            thumb: r.thumb || '',
            imageURL: r.imageURL || '',
            previewURL: r.previewURL || '',
            isAnimated: !!r.isAnimated,
            webpFrame: Number.isInteger(r.webpFrame) ? r.webpFrame : 0,
            webpTotalFrames: Number.isInteger(r.webpTotalFrames) ? r.webpTotalFrames : 0,
            title: r.title || '',
            startTC: r.startTC || '',
            endTC: r.endTC || '',
            desc: r.desc || '',
            camera: (r.camera != null ? r.camera : (defaults.camera || '')),
            lens:   (r.lens   != null ? r.lens   : (defaults.lens   || '')),
            take:   (r.take   != null ? r.take   : (defaults.take   || '')),
            notes:  (r.notes  != null ? r.notes  : (defaults.notes  || '')),
            selected:false,
            starred: (r.starred != null ? !!r.starred : !!defaults.starred),
            collapsed:true
           };
            if (base.mediaType==='image' && r.imageData && !base.imageURL){
              const b = dataURLtoBlob(r.imageData);
              if (b){ try{ base.imageURL = URL.createObjectURL(b); base.isAnimated = true; if(!base.format) base.format='WEBP'; }catch{} }
            }
            return base;
          });
        } else {
          for (let i=0;i<tpl.shots.length;i++){
            const r = tpl.shots[i], s = target[i]; if(!s) break;
            if(r.title   != null) s.title   = r.title;
            if(r.startTC != null) s.startTC = r.startTC;
            if(r.endTC   != null) s.endTC   = r.endTC;
            if(r.desc    != null) s.desc    = r.desc;
            if(r.camera  != null) s.camera  = r.camera;
            if(r.lens    != null) s.lens    = r.lens;
            if(r.take    != null) s.take    = r.take;
            if(r.notes   != null) s.notes   = r.notes;
            if(r.starred != null) s.starred = !!r.starred;
          }
        }
      }
      if (typeof window.resetInfinite === 'function') window.resetInfinite();
      if (typeof window.render === 'function') window.render();
    }catch(err){
      console.warn('applyShotTemplate failed:', err);
      alert('Failed to apply template: ' + (err && err.message ? err.message : err));
    }
  }
  window.loadBoardData = function(data){
    try{
      if (data && data.meta && data.meta.app === 'shotlist-maker' && Array.isArray(data.shots)){
        window.shots = data.shots.map(s => {
          const base = {
            selected:false, starred:!!s.starred, collapsed:true,
            startTC: s.startTC || s.timecode || '',
            format: s.format || (typeof guessFormatFromFilename==='function' && s.filename ? guessFormatFromFilename(s.filename) : s.format),
            mediaType: s.mediaType || 'image',
            imageURL: s.imageURL || '',
            previewURL: s.previewURL || '',
            isAnimated: !!s.isAnimated,
            webpFrame: Number.isInteger(s.webpFrame) ? s.webpFrame : 0,
            webpTotalFrames: Number.isInteger(s.webpTotalFrames) ? s.webpTotalFrames : 0,
            ...s
          };
          if (base.mediaType==='image' && base.imageData && !base.imageURL){
            const b = dataURLtoBlob(base.imageData);
            if (b){ try{ base.imageURL = URL.createObjectURL(b); base.isAnimated = true; if(!base.format) base.format='WEBP'; }catch{} }
          }
          return base;
        });
if (typeof window.resetInfinite === 'function') window.resetInfinite();
        if (typeof window.render === 'function') window.render();
      } else {
        applyShotTemplate(data || {});
      }
    }catch(e){
      console.warn('loadBoardData failed:', e);
      alert('Failed to load template: ' + (e && e.message ? e.message : e));
    }
  };
})();
</script>


<!-- === Templates Modal (scoped) === -->
<style id="tplModalStyles">
  #tplOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.55);
    backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%);
    display:none; z-index:9999; }
  #tplOverlay.show{ display:block; }
  #tplOverlay .tpl-modal{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(1200px, 92vw); height:min(720px, 88vh);
    background:var(--panel); color:var(--text);
    border:1px solid rgba(255,255,255,.14); border-radius:16px; box-shadow:0 22px 60px rgba(0,0,0,.55);
    display:grid; grid-template-rows:auto 1fr; }
  #tplOverlay .tpl-header{ display:flex; gap:10px; align-items:center; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12); }
  #tplSearch{ flex:1; height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06); color:var(--text); padding:0 12px; outline:none; }
  #tplClose{ border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08);
    color:var(--text); padding:8px 12px; cursor:pointer; }
  #tplOverlay .tpl-body{ display:grid; grid-template-columns:260px 1fr; min-height:0; }
  #tplTreePane{ border-right:1px solid rgba(255,255,255,.10); padding:10px; overflow:auto; }
  .tpl-tree .folder-row{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; cursor:pointer; user-select:none; }
  .tpl-tree .folder-row:hover{ background:rgba(255,255,255,.06); }
  .tpl-tree .folder-row.active{ outline:2px solid var(--accent); outline-offset:2px; background:rgba(255,255,255,.08); }
  .tpl-tree .caret{ display:inline-block; width:14px; text-align:center; opacity:.9; transform:rotate(0deg); transition:transform .15s ease; }
  .tpl-tree .is-open>.folder-row .caret{ transform:rotate(90deg); }
  .tpl-tree .count{ margin-left:auto; opacity:.8; font-size:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16);
    padding:2px 8px; border-radius:999px; }
  .tpl-tree ul{ margin:0; padding-left:16px; list-style:none; } .tpl-tree li{ margin:2px 0; } .tpl-tree .recent-icon{ font-size:12px; opacity:.8; }
  #tplGridPane{ padding:10px; overflow:auto; }
  #tplGrid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px; }
  .tpl-card{ display:grid; grid-template-rows:auto 1fr auto; gap:8px; background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:10px; }
  .tpl-thumb{ height:140px; border-radius:10px; background:rgba(0,0,0,.4); display:grid; place-items:center; overflow:hidden; }
  .tpl-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .tpl-name{ font-weight:700; } .tpl-meta{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tpl-actions{ display:flex; gap:8px; }
  .tpl-btn{ flex:1 1 0; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:var(--text); cursor:pointer; }
  .tpl-btn:hover{ filter:brightness(1.08); }
  @media (max-width:780px){ #tplOverlay .tpl-body{ grid-template-columns: 1fr; } #tplTreePane{ display:none; } }
</style>

<div id="tplOverlay" aria-hidden="true">
  <div class="tpl-modal" role="dialog" aria-modal="true">
    <div class="tpl-header">
      <input id="tplSearch" type="search" placeholder="Search templates…"/>
      <button id="tplClose">Close</button>
    </div>
    <div class="tpl-body">
      <aside id="tplTreePane"><div class="tpl-tree" id="tplTree" aria-label="Folders"></div></aside>
      <section id="tplGridPane"><div id="tplGrid"></div></section>
    </div>
  </div>
</div>

<script id="tplModalScript">
(()=>{
  const $ = (s, r=document)=>r.querySelector(s);
  const grid = $('#tplGrid'), treeEl = $('#tplTree'), searchEl = $('#tplSearch'), overlay = $('#tplOverlay');
  function openModal(){ overlay.classList.add('show'); searchEl && searchEl.focus(); }
  function closeModal(){ overlay.classList.remove('show'); }
  $('#tplClose')?.addEventListener('click', closeModal);
  overlay?.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
  document.getElementById('btnTemplates')?.addEventListener('click', openModal);

  const MANIFEST_URLS = ['templates.json','templates/templates.json','boards.json'];
  async function fetchJSON(url){ const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status+' for '+url); return res.json(); }
  function detectGhRepo(){ try{ if(!location.hostname.endsWith('github.io')) return null;
    const owner = location.hostname.split('.')[0]; const repo = location.pathname.replace(/^\/+/, '').split('/')[0] || null; return (owner && repo) ? {owner, repo} : null; }catch(_){ return null; } }
  async function scanGithub(branch){
    const repo = detectGhRepo(); if(!repo) throw new Error('Not GitHub Pages');
    const {owner, repo:reponame} = repo;
    const api = `https://api.github.com/repos/${owner}/${reponame}/git/trees/${branch}?recursive=1`;
    const res = await fetch(api, {headers:{'Accept':'application/vnd.github+json'}, cache:'no-store'});
    if(!res.ok) throw new Error('GitHub API '+res.status);
    const data = await res.json();
    return (data.tree||[]).filter(n => n.type==='blob' && /^templates\/.+\.json$/i.test(n.path)).map(n=>{
      const file = n.path, parts = file.split('/'), base = parts.pop().replace(/\.json$/i,''), folder= parts.slice(1).join('/');
      const name = base.replace(/[-_]/g,' ').replace(/\s+/g,' ').trim(); const thumbnail = file.replace(/\.json$/i,'.png');
      return { name, file, folder, thumbnail };
    });
  }
  async function listTemplates(){
    try{ return await scanGithub('main'); }catch(_){}
    try{ return await scanGithub('master'); }catch(_){}
    for(const u of MANIFEST_URLS){
      try{
        const arr = await fetchJSON(u);
        if (Array.isArray(arr) && arr.length){
          return arr.filter(t => (t.file||'').endsWith('.json')).map(t=>{
            const file = t.file;
            const folder = (t.folder||t.dir||file.split('/').slice(1,-1).join('/')).replace(/^templates\/?/,'');
            const name = t.name || file.split('/').pop().replace(/\.json$/,'');
            const thumbnail = t.thumbnail || file.replace(/\.json$/i,'.png');
            return { ...t, name, file, folder, thumbnail };
          });
        }
      }catch(_){}
    }
    return [];
  }

  let allTemplates = [], selected = ''; const expanded = new Set(['']); const RECENT_KEY = 'tpl_recent_v1';
  function rememberRecent(file){ try{ const now = Date.now();
    const r = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]').filter(x => x.file !== file);
    r.unshift({file, ts: now}); localStorage.setItem(RECENT_KEY, JSON.stringify(r.slice(0,30))); }catch(_){ } }
  function getRecent(){ try{ const r = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]'); const files = new Set(r.map(x=>x.file));
    return allTemplates.filter(t=>files.has(t.file)); }catch(_){ return []; } }
  function getFolderPath(t){ const p = (t.folder||'').trim(); return p.replace(/^\.?\/*/,'').replace(/^templates\/?/,''); }
  function buildTree(list){ const root = {name:'All templates', path:'', children:new Map(), count:0};
    for(const t of list){ const parts = getFolderPath(t).split('/').filter(Boolean); let node = root; node.count++; let cur='';
      for(const part of parts){ cur = cur ? `${cur}/${part}` : part; if(!node.children.has(part)) node.children.set(part, {name:part, path:cur, children:new Map(), count:0}); node = node.children.get(part); node.count++; } }
    return root; }
  function renderTree(){
    const root = buildTree(allTemplates); treeEl.innerHTML = '';
    const recent = getRecent();
    if (recent.length){ const r = document.createElement('div'); r.className = 'folder-row' + (selected==='__recent__' ? ' active':'');
      r.dataset.path='__recent__'; r.innerHTML = `<span class="recent-icon">★</span><span>Recent</span><span class="count">${recent.length}</span>`;
      r.onclick = ()=>{ selected='__recent__'; renderTree(); renderGrid(); }; treeEl.appendChild(r); }
    const allRow = document.createElement('div'); allRow.className = 'folder-row' + (selected==='' ? ' active' : ''); allRow.dataset.path='';
    allRow.innerHTML = `<span class="caret">•</span><span>All templates</span><span class="count">${root.count}</span>`;
    allRow.onclick = ()=>{ selected=''; renderTree(); renderGrid(); }; treeEl.appendChild(allRow);
    const ul = document.createElement('ul');
    function draw(node){ for(const [name, child] of node.children){ const li=document.createElement('li'); const row=document.createElement('div');
      row.className='folder-row' + (selected===child.path ? ' active':'');
      row.innerHTML = `<span class="caret">▸</span><span>${name}</span><span class="count">${child.count}</span>`;
      li.appendChild(row); row.onclick = (e)=>{ e.stopPropagation(); if(expanded.has(child.path)) expanded.delete(child.path); else expanded.add(child.path); selected = child.path; renderTree(); renderGrid(); };
      const hasKids = child.children && child.children.size; if(hasKids){ const sub=document.createElement('ul');
        if(expanded.has(child.path)){ li.classList.add('is-open'); sub.style.display='block'; } else { sub.style.display='none'; }
        li.appendChild(sub); draw({children: child.children}); } ul.appendChild(li); } }
    draw(root); treeEl.appendChild(ul);
  }
  function matchQuery(t,q){ if(!q) return true; const hay = `${t.name||''} ${(t.tags||[]).join(' ')} ${t.file||''}`; return hay.toLowerCase().includes(q.toLowerCase()); }
  function renderGrid(){
    grid.innerHTML=''; const q=(searchEl && searchEl.value || '').trim();
    let list = allTemplates.filter(t=>matchQuery(t,q));
    if (selected==='__recent__'){ const rset = new Set(getRecent().map(x=>x.file)); list = list.filter(t=>rset.has(t.file)); }
    else if (selected){ list = list.filter(t=>{ const p=getFolderPath(t); return p===selected || p.startsWith(selected+'/'); }); }
    if(!list.length){ const div=document.createElement('div'); div.style.opacity='.75'; div.textContent='No templates found.'; grid.appendChild(div); return; }
    for(const t of list){
      const card=document.createElement('div'); card.className='tpl-card';
      const thumb=document.createElement('div'); thumb.className='tpl-thumb';
      if(t.thumbnail){ const img=document.createElement('img'); img.src=t.thumbnail; img.alt=t.name||'Template'; thumb.appendChild(img); } else { thumb.textContent='No preview'; }
      const name=document.createElement('div'); name.className='tpl-name'; name.textContent=t.name || t.file;
      const meta=document.createElement('div'); meta.className='tpl-meta'; meta.textContent = t.folder ? `templates/${t.folder}` : 'templates';
      const actions=document.createElement('div'); actions.className='tpl-actions';
      const loadBtn=document.createElement('button'); loadBtn.className='tpl-btn'; loadBtn.textContent='Load';
      loadBtn.onclick = async ()=>{ try{ const data = await fetchJSON(t.file); if (typeof loadBoardData === 'function') loadBoardData(data); rememberRecent(t.file); overlay.classList.remove('show'); }catch(e){ alert('Failed to load '+t.file+': '+e.message); } };
      const linkBtn=document.createElement('button'); linkBtn.className='tpl-btn'; linkBtn.textContent='Share link';
      linkBtn.onclick = async ()=>{ const u = new URL(location.href); u.searchParams.set('src', t.file); try{ await navigator.clipboard.writeText(u.toString()); alert('Link copied!'); } catch(e){ prompt('Copy link:', u.toString()); } };
      actions.appendChild(loadBtn); actions.appendChild(linkBtn);
      card.appendChild(thumb); card.appendChild(name); card.appendChild(meta); card.appendChild(actions); grid.appendChild(card);
    }
  }
  searchEl?.addEventListener('input', ()=> renderGrid());
  (async function initTemplates(){
    try{ allTemplates = await listTemplates(); }catch(e){ console.warn('Template discovery failed:', e); allTemplates = []; }
    renderTree(); renderGrid();
    try{ const sp = new URLSearchParams(location.search); const src = sp.get('src'); if (src){ const data = await fetchJSON(src); if (typeof loadBoardData === 'function') loadBoardData(data); } }catch(e){ console.warn('Auto-load via ?src failed:', e); }
  })();
})();
</script>

<script>
// print
printBtn.addEventListener('click',()=>{
  if(shots.length===0){ alert('No shots to print.'); return; }
  const list=filteredShots(), w=window.open('','_blank');
  const styles=`@page{size:A4;margin:14mm} body{font:12px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px} .card{break-inside:avoid;border:1px solid #d7dae0;border-radius:8px;padding:8px}
    .head{display:flex;justify-content:space-between;align-items:center;font-weight:600;margin-bottom:6px;font-size:11px}
    .thumb{width:100%;height:140px;object-fit:cover;background:#000;border-radius:4px}
    .meta{font-size:10px;color:#333;margin-top:4px} .label{color:#6b7280} h1{font-size:14px;margin:0 0 8px} .note{font-size:10px;color:#555;margin-bottom:10px}
    .desc{white-space:pre-wrap}`;
  const title=document.title, time=new Date().toLocaleString();
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>${title} — Print</title><style>${styles}</style><style id="drop-follow-box-style">
  #drop-follow-box{
    position:absolute;
    border:2px dashed #3b82f6;
    border-radius:12px;
    pointer-events:none;
    z-index:9999;
    background:rgba(59,130,246,0.06);
    display:none;
  }
</style>
</head><body>
    <h1>Shot List</h1><div class="note">Generated ${time}. Use your browser’s <b>Save as PDF</b>.</div><div class="grid">${
      list.map((s,i)=>`
        <div class="card">
          <div class="head"><div>#${String(i+1).padStart(3,'0')} ${s.starred?'★':''} — ${escapeHtml(s.title||'')}</div><div>${
            escapeHtml((s.startTC||'')+(s.endTC? ' — '+s.endTC : ''))}</div></div>
          <img class="thumb" src="${s.thumb}" alt="thumb">
          <div class="meta"><span class="label">File:</span> ${escapeHtml(s.filename)} &nbsp; <span class="label">Type:</span> ${escapeHtml(s.format||'')}</div>
          <div class="meta"><span class="label">Camera:</span> ${escapeHtml(s.camera||'')} &nbsp; <span class="label">Lens:</span> ${escapeHtml(s.lens||'')}</div>
          <div class="meta"><span class="label">Take:</span> ${escapeHtml(s.take||'')}</div>
          <div class="meta desc"><span class="label">Desc:</span> ${escapeHtml(s.desc||'')}</div>
          <div class="meta"><span class="label">Notes:</span> ${escapeHtml(s.notes||'')}</div>
        </div>`).join('')}</div><script>setTimeout(()=>window.print(),400)<\/script></body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
});


// shortcuts (disabled while typing)
document.addEventListener('keydown',(e)=>{
  const tag=(e.target&&e.target.tagName||'').toLowerCase();
  const typing=['input','textarea','select'].includes(tag) || (e.target && e.target.isContentEditable);
  if(typing) return;
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='a'){ e.preventDefault(); shots.forEach(s=>s.selected=true); render(); }
  else if(e.key==='Delete'){ const any=shots.some(s=>s.selected); if(any){ shots=shots.filter(s=>!s.selected); render(); } }
  else if(e.key.toLowerCase()==='p'){ e.preventDefault(); printBtn.click(); }
});

function escapeHtml(str){ return String(str).replace(/[&<>\"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

// --- Export CSV ---
function csvEscape(v){
if (v === undefined || v === null) return '';
const s = String(v).replace(/\r\n/g, '\n').replace(/\r/g, '\n');
return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
}
function buildCsvRows(list){
const headers = [
  'Index','Filename','Format','MediaType','Title','Description',
  'Camera','Lens','Take','Notes','StartTC','EndTC','Starred','WebPFrame','WebPTotalFrames'
];
const rows = list.map((s, i) => [
  i+1,
  s.filename||'',
  s.format||'',
  s.mediaType||'',
  s.title||'',
  s.desc||'',
  s.camera||'',
  s.lens||'',
  s.take||'',
  s.notes||'',
  s.startTC||'',
  s.endTC||'',
  s.starred ? 1 : 0,
  (Number.isInteger(s.webpFrame) ? s.webpFrame : ''),
  (s.webpTotalFrames || '')
]);
return [headers, ...rows];
}
exportCSVBtn.addEventListener('click', (e)=>{
const list = (typeof filteredShots === 'function' ? filteredShots() : shots) || [];
if(!list.length){ alert('No shots to export.'); return; }
// Alt/Option-click to export ALL, otherwise export current filtered view
const out = (e && e.altKey) ? shots : list;
const rows = buildCsvRows(out);
const csv = rows.map(r => r.map(csvEscape).join(',')).join('\r\n');
const blob = new Blob(["\ufeff"+csv], {type: 'text/csv;charset=utf-8;'}); // BOM for Excel
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
a.download = 'shotlist.csv';
document.body.appendChild(a);
a.click();
setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
});
</script>

</body>
</html>
